---
title: 8.理解redux中间件
categories:
  - 01.开发学习笔记 markdown
  - 08.前端框架
  - 02.redux
tags:
  - redux
date:
---

中间件middleware是介于应用系统和系统软件之间的一类软件。使用系统软件提供的基础服务功能，衔接应用系统的各个部分或不同的应用，达到资源共享、功能共享的目的。


redux 中间件  指的是action 和 store之间的中间件，在dispatch过程中，在分发action时进行拦截处理。


Action之前 只能是一个对象 通过dispatch 派发给store  有了Middleware对dispatch作一个高级封装
Action就可以是一个函数了 dispatch可以派发一个函数 当它发现这是一个函数时 它就会先执行这个函数 等到要发送给store时 发送执行后的对象给store

其他中间件

redux-thunk 是把异步逻辑放在action里执行
redux-saga 是把异步逻辑单独放在一个文件里统一管理 
redux-logger 日志功能

实现原理：
```js
export default function applyMiddleware(...middlewares) {
	return (createStore) => (reducer, preloadedState, enhancer) => {
		var store = createStore(reducer, preloadedState, enhancer);
		var dispatch = store.dispatch;
		var chain = [];

		var middlewareAPI = {
			getState: store.getState,
			dispatch: (action) => dispatch(action)
		};
		chain = middlewares.map((middleware) => middleware(middlewareAPI));
		dispatch = compose(...chain)(store.dispatch);

		return { ...store, dispatch };
	};
}
```

所有中间件被放入一个数组chain，然后嵌套执行，最后执行store.dispatch，可以看到，中间件内部(middlewareAPI)可以拿到getState和dispatch两个方法。

如redux-thunk内部会对dispatch进行一个判断，然后执行对应操作：

```js
function patchThunk(store) {
	let next = store.dispatch;

	function dispatchAndThunk(action) {
		if (typeof action === 'function') {
			action(store.dispatch, store.getState);
		} else {
			next(action);
		}
	}

	store.dispatch = dispatchAndThunk;
}
```

实现⼀个⽇志输出的原理也⾮常简单，如下：
```js
let next = store.dispatch;

function dispatchAndLog(action) {
	console.log('dispatching:', addAction(10));
	next(addAction(5));

	console.log(' 新的state:', store.getState());
}

store.dispatch = dispatchAndLog;
```