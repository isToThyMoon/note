# 移动端

# 唤端

一般来说，类似落地页引流需要唤端打开app，主要是引流。

唤端技术我们也称之为**`deep link`**技术。当然，不同平台的实现方式有些不同，一般常见的有这几种，分别是：

- URL Scheme（通用）
- Universal Link （iOS）
- App Link、Chrome Intents（android）

## **URL Scheme（通用）**

这种方式是一种比较通用的技术，各平台的兼容性也很好，它一般由**`协议名、路径、参数`**组成。这个一般是由Native开发的同学提供，我们前端同学再拿到这个scheme之后，就可以用来打开APP或APP内的某个页面了。

**URL Scheme 组成**

`[scheme:][//authority][path][?query][#fragment]`

http是一种scheme。

**常用APP的 URL Scheme**：`weixin://` `alipay://`…

更常用的是这种：`scheme://[path][?query]` ，scheme是应用标识，path是行为，应用的某个功能，query就是正常参数。

### 打开方式：

• 直接使用a标签进行跳转.使用过程中，对于动态生成的 a 标签，使用 `dispatch` 来模拟触发点击事件，发现很多种 event 传递过去都无效；使用 `click()` 来模拟触发，部分场景下存在这样的情况，第一次点击过后，回到原先页面，再次点击，点击位置和页面所识别位置有不小的偏移，所以 Intent 协议从 a 标签换成了 window.location。

• 直接通过window.location.href跳转 `window.location.href = 'zhihu://'` 

URL Scheme 在 ios 9+ 上诸如 safari、UC、QQ浏览器中， iframe 均无法成功唤起 APP，只能通过 window.location 才能成功唤端。

当然，如果我们的 app 支持 Universal Link，ios 9+ 就用不到 URL Scheme 了。而 Universal Link 在使用过程中，我发现在 qq 中，无论是 iframe 导航 还是 a 标签打开 又或者 window.location 都无法成功唤端，一开始我以为是 qq 和微信一样禁止了 Universal Link 唤端的功能，其实不然，百般试验下，通过 top.location 唤端成功了。

• 通过iframe跳转 `<iframe src="sinaweibo://qrcode">` 在只有 URL Scheme 的日子里，iframe 是使用最多的了。因为在未安装 app 的情况下，不会去跳转错误页面。但是 iframe 在各个系统以及各个应用中的兼容问题还是挺多的，不能全部使用 URL Scheme。

```jsx
const iframe = document.createElement('iframe')
iframe.style.display = 'none'
iframe.src = 'zhihu://'
document.body.appendChild(iframe)
```

• 通过js bridge来打开 `window.miduBridge.call('openAppByRouter', {url: 'zhihu://'})`

URL Scheme 这种方式兼容性好，无论安卓或者 iOS 都能支持，是目前最常用的方式。它也有一些比较明显的缺点：

- 无法准确判断是否唤起成功，因为本质上这种方式就是打开一个链接，并且还不是普通的 http 链接，所以如果用户没有安装对应的 APP，那么尝试跳转后在浏览器中会没有任何反应，通过定时器来引导用户跳到应用商店，但这个定时器的时间又没有准确值，不同手机的唤端时间也不同，我们只能大概的估计一下它的时间来实现，一般设为3000ms左右比较合适；
- 从上图中我们可以看到会有一个弹窗提示你是否在对应 APP中打开，这就可能会导致用户流失；
- 当注册有多个scheme相同的时候，没有办法区分。有 URL Scheme 劫持风险，比如有一个 app 也向系统注册了 `zhihu://` 这个 scheme ，唤起流量可能就会被劫持到这个 app 里；
- 容易被屏蔽，app 很轻松就可以拦截掉通过 URL Scheme 发起的跳转，比如微信内经常能看到一些被屏蔽的现象。
- 不支持从其他app中的UIWebView中跳转到目标APP， 所以ios和android都出现了自己的独有解决方案。

## **App Link、Chrome Intents（Android）**

墙的原因导致google市场无法使用，**App Link Chrome Intent这两种方案在国内的应用都比较少。**

### App Link

在2015年的Google I/O大会上，Android M宣布了一个新特性：App Links让用户在点击一个普通web链接的时候可以打开指定APP的指定页面，前提是这个APP已经安装并且经过了验证，否则会显示一个打开确认选项的弹出框，只支持Android M以上系统。

App Links的最大的作用，就是可以避免从页面唤醒App时出现的选择浏览器选项框;

前提是必须注册相应的Scheme，就可以实现直接打开关联的App。

- App links在国内的支持还不够，部分安卓浏览器并不支持跳转至App，而是直接在浏览器上打开对应页面。
- 系统询问是否打开对应App时，假如用户选择“取消”并且选中了“记住此操作”，那么用户以后就无法再跳转App。

优缺点与 universal Link 类似，缺点在于国内的支持相对较差，在有的浏览器或者手机ROM中并不能链接至APP，而是在浏览器中打开了对应的链接。在询问是否用APP打开对应的链接时，如果选择了“取消”并且“记住选择”被勾上，那么下次你再次想链接至APP时就不会有任何反应

### **Chrome Intent**

• Chrome Intent 是 Android 设备上 Chrome 浏览器中 URI 方案的深层链接替代品。

• 如果 APP 已安装，则通过配置的 URI SCHEME 打开 APP。

• 如果 APP 未安装，配置了 fallback url 的跳转 fallback url，没有配置的则跳转应用市场。

安卓的原生谷歌浏览器自从 chrome25 版本开始对于唤端功能做了一些变化，URL Scheme 无法再启动Android应用。 例如，通过 iframe 指向 `weixin://`，即使用户安装了微信也无法打开。所以，APP需要实现谷歌官方提供的 `intent:` 语法，或者实现让用户通过自定义手势来打开APP，当然这就是题外话了。

```bash
intent:
   HOST/URI-path // Optional host 
   #Intent; 
      package=[string]; 
      action=[string]; 
      category=[string]; 
      component=[string]; 
      scheme=[string]; 
   end;
```

如果用户未安装 APP，则会跳转到系统默认商店。当然，如果你想要指定一个唤起失败的跳转地址，添加下面的字符串在 `end;` 前就可以了:

```bash

S.browser_fallback_url=[encoded_full_url]
```

### 示例

下面是打开 Zxing 二维码扫描 APP 的 intent。

```bash

intent:
   //scan/
   #Intent;
      package=com.google.zxing.client.android;
      scheme=zxing;
   end;

```

打开这个 APP ，可以通过如下的方式：

```html

<a 
	href="intent://scan/#Intent;scheme=zxing;package=com.google.zxing.client.android;S.browser_fallback_url=http%3A%2F%2Fzxing.org;end"
> Take a QR code </a>

```

## Universal Link

### Universal Link 是什么

Universal Link 苹果在WWDC2015`iOS 9`中新增的功能，使用它可以直接通过`https`协议的链接来打开 APP。
它相比前一种`URL Scheme`的优点在于它是使用`https`协议，所以如果没有唤端成功，那么就会直接打开这个网页，不再需要判断是否唤起成功了。并且使用 Universal Link，不会再弹出是否打开的弹出，对用户来说，唤端的效率更高了，减少一部分用户流失。

universal Link 是从服务器上查询是哪个APP需要被打开，所以不会存在冲突问题。

支持从其他app中的UIWebView中跳转到目标app。

缺点在于会记住用户的选择：在用户点击了Universal link之后，iOS会去检测用户最近一次是选择了直接打开app还是打开网站。一旦用户点击了这个选项，他就会通过safiri打开你的网站。并且在之后的操作中，默认一直延续这个选择，除非用户从你的webpage上通过点击Smart App Banner上的OPEN按钮来打开。

但只能够在iOS上使用，只能由用户主动触发。

Scheme 在微信、微博、QQ浏览器、手百中都已经被禁止使用，使用 Universal Link 可以避开它们的屏蔽（ 截止到 18年8月21日，微信和QQ浏览器已经禁止了 Universal Link，其他主流APP未发现有禁止 ）

### **如何让 APP 支持 Universal Link**

• 在 APP 中注册自己要支持的域名；

• 在自己域名的根目录下配置一个 **`apple-app-site-association`** 文件即可。（具体的配置前端同学不用关注，只需与iOS同学确认好支持的域名即可）

有大量的文章会详细的告诉我们如何配置，你也可以去看[官方文档](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.apple.com%2Flibrary%2Farchive%2Fdocumentation%2FGeneral%2FConceptual%2FAppSearch%2FUniversalLinks.html%23%2F%2Fapple_ref%2Fdoc%2Fuid%2FTP40016308-CH12-SW2)。

1. 拥有一个支持 **https** 的域名
2. 在 [开发者中心](https://link.juejin.cn/?target=https%3A%2F%2Fdeveloper.apple.com%2F) ，Identifiers 下 AppIDs 找到自己的 App ID，编辑打开 Associated Domains 服务。
3. 打开工程配置中的 Associated Domains ，在其中的 Domains 中填入你想支持的域名，必须以 `applinks:` 为前缀
4. 配置 `apple-app-site-association` 文件，文件名必须为 `apple-app-site-association` ，**不带任何后缀**
5. 上传该文件到你的 HTTPS 服务器的 **根目录** 或者 `.well-known` 目录下

### Universal Link 配置中的坑

这里放一下我们在配置过程中遇到的坑，当然首先你在配置过程中必须得严格按照上面的要求去做，尤其是加粗的地方。

1. 跨域问题
    
    IOS 9.2 以后，必须要触发跨域才能支持 Universal Link 唤端。
    
    IOS 那边有这样一个判断，如果你要打开的 Universal Link 和 当前页面是同一域名，ios 尊重用户最可能的意图，直接打开链接所对应的页面。如果不在同一域名下，则在你的 APP 中打开链接，也就是执行具体的唤端操作。
    
2. Universal Link 是空页面
    
    Universal Link 本质上是个空页面，如果未安装 APP，Universal Link 被当做普通的页面链接，自然会跳到 404 页面，所以我们需要将它绑定到我们的中转页或者下载页。
    

## 判断唤端是否成功

如果唤端失败（APP 未安装），我们总是要做一些处理的，可以是跳转下载页，可以是 ios 下跳转 App Store... 但是Js 并不能提供给我们获取 APP 唤起状态的能力，Android Intent 以及 Universal Link 倒是不用担心，它们俩的自身机制允许它们唤端失败后直接导航至相应的页面，但是 URL Scheme 并不具备这样的能力，所以我们只能通过一些很 hack 的方式来实现 APP 唤起检测功能。

```html
// 一般情况下是 visibilitychange
const visibilityChangeProperty = getVisibilityChangeProperty();
const timer = setTimeout(() => {
  const hidden = isPageHidden();
  if (!hidden) {
    cb();
  }
}, timeout);

if (visibilityChangeProperty) {
  document.addEventListener(visibilityChangeProperty, () => {
    clearTimeout(timer);
  });

  return;
}

window.addEventListener('pagehide', () => {
  clearTimeout(timer);
});

```

APP 如果被唤起的话，页面就会进入后台运行，会触发页面的 visibilitychange 事件。如果触发了，则表明页面被成功唤起，及时调用 clearTimeout ，清除页面未隐藏时的失败函数（callback）回调。

当然这个事件是有兼容性的，具体的代码实现时做了事件是否需要添加前缀（比如 -webkit- ）的校验。如果都不兼容，我们将使用 pagehide 事件来做兜底处理。

## **没有完美的方案**

透过上面的几个点，我们可以发现，无论是 *唤端媒介* 、 *调用唤端媒介* 还是 *判断唤端结果* 都没有一个十全十美的方法，我们在代码层上能做的只是在确保最常用的场景（比如 微信、微博、手百 等）唤端无误的情况下，最大化的兼容剩余的场景。

## 微信、微博、手百、QQ浏览器等

这些应用能阻止唤端是因为它们直接屏蔽掉了 URL Scheme 。接下来可能就有看官疑惑了，微信中是可以打开大众点评的呀，微博里面可以打开优酷呀，那是如何实现的呢？
它们都各自维护着一个白名单，如果你的域名在白名单内，那这个域名下所有的页面发起的 URL Scheme 就都会被允许。就像微信，如果你是腾讯的“家属”，你就可以加入白名单了，微信的白名单一般只包含着“家属”，除此外很难申请到白名单资质。但是微博之类的都是可以联系他们的渠道童鞋进行申请的，只是条件各不相同，比如微博的就是在你的 APP 中添加打开微博的入口，三个月内唤起超过 100w 次，就可以加入白名单了。腾讯应用宝直接打开 APP 的某个功能
刚刚我们说到，如果你不是微信的家属，那你是很难进入白名单的，所以在安卓中我们一般都是直接打开腾讯应用宝，ios 中 直接打开 App Store。点击腾讯应用宝中的“打开”按钮，可以直接唤起我们的 APP，但是无法打开 APP 中的某个功能（就是无法打开指定页面）。
腾讯应用宝对外开放了一个叫做 APP Link 的申请，只要你申请了 APP Link，就可以通过在打开应用宝的时候在应用宝地址后面添加上 `&android_schema={your_scheme}` ，来打开指定的页面了。

### **开箱即用的callapp-lib**

封装好的npm包，自行体验。